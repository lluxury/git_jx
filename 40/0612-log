
# è§£å†³ Fluent-bit åœ¨ EKS æ‰˜ç®¡èŠ‚ç‚¹ç»„ä¸Šçš„ `could not sign request` å’Œ `failed to create log group` é”™è¯¯

æ‚¨é‡åˆ°çš„è¿™ä¸¤ä¸ªé”™è¯¯ (`could not sign request` å’Œ `failed to create log group`) é€šå¸¸éƒ½ä¸ AWS æƒé™é…ç½®æœ‰å…³ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„æ’æŸ¥å’Œè§£å†³æ–¹æ¡ˆï¼š

## 1. æ ¹æœ¬åŸå› åˆ†æ

### é”™è¯¯ 1: "could not sign request"
- ğŸ”´ **é—®é¢˜æœ¬è´¨**: Fluent-bit æ— æ³•è·å–æœ‰æ•ˆçš„ AWS å‡­è¯æ¥ç­¾ç½² API è¯·æ±‚
- å¯èƒ½åŸå› :
  - IAM Role æœªæ­£ç¡®é™„åŠ åˆ°èŠ‚ç‚¹ç»„
  - ServiceAccount æœªæ­£ç¡®é…ç½® IRSA
  - èŠ‚ç‚¹å®ä¾‹è§’è‰²æƒé™ä¸è¶³

### é”™è¯¯ 2: "failed to create log group"
- ğŸ”´ **é—®é¢˜æœ¬è´¨**: è™½ç„¶æœ‰å‡­è¯ï¼Œä½†æƒé™ä¸è¶³ä»¥åˆ›å»º CloudWatch Log Group
- å¯èƒ½åŸå› :
  - ç¼ºå°‘ `logs:CreateLogGroup` æƒé™
  - èµ„æºé™åˆ¶æˆ–åŒºåŸŸé”™è¯¯

## 2. å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä½¿ç”¨ IRSA (æ¨è)

#### æ­¥éª¤ 1: åˆ›å»º IAM OIDC æä¾›è€… (å¦‚æœå°šæœªåˆ›å»º)
```bash
eksctl utils associate-iam-oidc-provider \
  --cluster <your-cluster-name> \
  --region <region> \
  --approve
```

#### æ­¥éª¤ 2: åˆ›å»º IAM ç­–ç•¥
```bash
cat > fluent-bit-policy.json << 'EOF'
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:PutLogEvents",
                "logs:CreateLogStream",
                "logs:CreateLogGroup",
                "logs:DescribeLogStreams"
            ],
            "Resource": "*"
        }
    ]
}
EOF

aws iam create-policy \
  --policy-name FluentBitCloudWatchPolicy \
  --policy-document file://fluent-bit-policy.json
```

#### æ­¥éª¤ 3: åˆ›å»º ServiceAccount å¹¶é™„åŠ ç­–ç•¥
```bash
eksctl create iamserviceaccount \
  --name fluent-bit \
  --namespace logging \
  --cluster <your-cluster-name> \
  --attach-policy-arn arn:aws:iam::<your-account-id>:policy/FluentBitCloudWatchPolicy \
  --approve \
  --override-existing-serviceaccounts
```

#### æ­¥éª¤ 4: æ›´æ–° Fluent-bit é…ç½®
ç¡®ä¿æ‚¨çš„ Fluent-bit é…ç½® **ä¸åŒ…å«** `aws_auth` æˆ– `aws_credentials_file` å‚æ•°ï¼Œæ­£ç¡®é…ç½®å¦‚ä¸‹ï¼š

```ini
[OUTPUT]
    Name cloudwatch_logs
    Match *
    region ${AWS_REGION}
    log_group_name /aws/eks/<cluster-name>/application
    log_stream_prefix fluent-bit-
    auto_create_group true
```

### æ–¹æ¡ˆ B: ä½¿ç”¨èŠ‚ç‚¹å®ä¾‹è§’è‰² (ä¸æ¨èä½†å¿«é€Ÿ)

#### æ­¥éª¤ 1: ä¸ºèŠ‚ç‚¹ç»„è§’è‰²æ·»åŠ æƒé™
```bash
# è·å–èŠ‚ç‚¹ç»„è§’è‰²å
NODE_ROLE=$(aws eks describe-nodegroup \
  --cluster-name <cluster-name> \
  --nodegroup-name <nodegroup-name> \
  --query "nodegroup.nodeRole" --output text | cut -d '/' -f 2)

# é™„åŠ ç­–ç•¥
aws iam attach-role-policy \
  --role-name $NODE_ROLE \
  --policy-arn arn:aws:iam::<your-account-id>:policy/FluentBitCloudWatchPolicy
```

#### æ­¥éª¤ 2: é‡å¯ Fluent-bit Pod
```bash
kubectl rollout restart deployment/fluent-bit -n logging
```

## 3. éªŒè¯æ­¥éª¤

### æ£€æŸ¥å‡­è¯æ¥æº
```bash
kubectl exec -it <fluent-bit-pod> -n logging -- env | grep AWS
```
âœ… æ­£ç¡®è¾“å‡ºåº”åŒ…å«:
```
AWS_ROLE_ARN=arn:aws:iam::1234567890:role/eksctl-xxx
AWS_WEB_IDENTITY_TOKEN_FILE=/var/run/secrets/eks.amazonaws.com/serviceaccount/token
```

### æ£€æŸ¥æƒé™
```bash
kubectl exec -it <fluent-bit-pod> -n logging -- \
  curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

### æŸ¥çœ‹ CloudWatch æ—¥å¿—ç»„
```bash
aws logs describe-log-groups \
  --log-group-name-prefix /aws/eks/<cluster-name> \
  --region <region>
```

## 4. é«˜çº§æ•…éšœæ’é™¤

### é”™è¯¯ 1: æŒç»­å‡ºç° "could not sign request"
1. æ£€æŸ¥ ServiceAccount æ³¨è§£:
   ```bash
   kubectl describe sa fluent-bit -n logging | grep eks.amazonaws.com/role-arn
   ```

2. éªŒè¯ IAM è§’è‰²ä¿¡ä»»å…³ç³»:
   ```bash
   aws iam get-role --role-name <fluent-bit-role-name>
   ```
   ç¡®ä¿åŒ…å«:
   ```json
   "Principal": {
       "Federated": "arn:aws:iam::<account-id>:oidc-provider/oidc.eks.<region>.amazonaws.com/id/<cluster-oidc-id>"
   }
   ```

### é”™è¯¯ 2: æŒç»­å‡ºç° "failed to create log group"
1. å°è¯•æ‰‹åŠ¨åˆ›å»ºæ—¥å¿—ç»„:
   ```bash
   aws logs create-log-group \
     --log-group-name /aws/eks/<cluster-name>/application \
     --region <region>
   ```

2. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è‡ªåŠ¨åˆ›å»º:
   ```ini
   auto_create_group true
   ```

## 5. å®Œæ•´ Helm Values ç¤ºä¾‹ (IRSA)

```yaml
# values.yaml
serviceAccount:
  create: false
  name: fluent-bit
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::<account-id>:role/eksctl-<cluster-name>-addon-iamserviceac-Role1-XXXXXX

config:
  outputs: |
    [OUTPUT]
        Name cloudwatch_logs
        Match *
        region ${AWS_REGION}
        log_group_name /aws/eks/<cluster-name>/application
        log_stream_prefix fluent-bit-
        auto_create_group true

env:
  - name: AWS_REGION
    value: <region>
  - name: AWS_STS_REGIONAL_ENDPOINTS
    value: regional
```

## 6. å…³é”®æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ··ç”¨å‡­è¯æ¥æº**:
   - å¦‚æœä½¿ç”¨ IRSAï¼Œç¡®ä¿èŠ‚ç‚¹å®ä¾‹è§’è‰² **ä¸åŒ…å«** CloudWatch æƒé™
   - é¿å…åŒæ—¶é…ç½® `aws_auth` å’Œ IRSA

2. **åŒºåŸŸä¸€è‡´æ€§**:
   - ç¡®ä¿ Fluent-bit é…ç½®çš„ `region` ä¸é›†ç¾¤åŒºåŸŸä¸€è‡´
   - æ£€æŸ¥ç¯å¢ƒå˜é‡ `AWS_REGION` æ˜¯å¦æ­£ç¡®è®¾ç½®

3. **æ—¥å¿—ç»„å‘½å**:
   - åç§°å‰ç¼€å¿…é¡»æ˜¯ `/aws/eks/`
   - é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨çš„ Fluent-bit åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å‘é€æ—¥å¿—åˆ° CloudWatchã€‚å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›å…·ä½“çš„é”™è¯¯æ—¥å¿—ç‰‡æ®µä»¥ä¾¿è¿›ä¸€æ­¥è¯Šæ–­ã€‚
